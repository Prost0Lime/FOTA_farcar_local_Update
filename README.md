# Подмена OTA-прошивки для ГУ Allwinner A133 (FOTA/ABUP) через локальный прокси

Этот способ позволяет «скормить» головному устройству (ГУ) нужный OTA-архив, даже если онлайн-загрузка рвётся или недоступна.
Идея: FOTA скачивает прошивку по **HTTP** c домена `*.mayitek.com`. Мы поднимаем локальный HTTP-прокси и **подменяем** ответ сервером — выдаём свой `.zip`.

## Что понадобится

* **Windows-ноут/ПК** (лучше — раздать Wi-Fi через «Мобильный хот-спот»).
* **mitmproxy** (пакет содержит `mitmdump.exe`).
* Скачанный **прошивочный .zip** (оригинал, без повреждений).
* ГУ подключено к хот-споту ноута и умеет выставлять **HTTP-прокси** для Wi-Fi.

> Интернет на ноуте **не обязателен** для самой закачки `.zip`. Но FOTA до скачивания может проверять метаданные по HTTPS (`abupdate.com`) — этот этап лучше проделать **без** прокси.

---

## 1) Установка mitmproxy

Скачай официальный установщик с [https://mitmproxy.org/](https://mitmproxy.org/) и установи.
Путь по умолчанию:

```
C:\Program Files\mitmproxy\bin\mitmdump.exe
```

---

## 2) Подготовь файлы

Создай папку, например `C:\fw`, и помести туда:

### 2.1. Прошивку

```
C:\fw\fu-5af72-13c0-4c57-98a7-bce3fc2309ab.zip
```

Проверь целостность (MD5 должен совпадать с тем, что отдаёт FOTA в логах):

```powershell
Get-FileHash C:\fw\fu-5af72-13c0-4c57-98a7-bce3fc2309ab.zip -Algorithm MD5
```

Ожидаем, например: `c20c06230f286c0de7315faa32bd5395`.

### 2.2. Скрипт `serve_zip_range.py`

Файл `C:\fw\serve_zip_range.py`:

```

### 2.3. (Опционально) батник `start_proxy.bat`

Создай `C:\fw\start_proxy.bat`:

```bat
@echo off
set PORT=8080
set MITM="C:\Program Files\mitmproxy\bin\mitmdump.exe"
set SCRIPT=C:\fw\serve_zip_range.py

if not exist %MITM% (
  echo [ERROR] Не найден mitmdump.exe по пути: %MITM%
  pause & exit /b 1
)
if not exist "%SCRIPT%" (
  echo [ERROR] Не найден скрипт: %SCRIPT%
  pause & exit /b 1
)

echo.
echo [INFO] Запускаю прокси на порту %PORT%...
echo [INFO] Если Windows спросит о доступе через брандмауэр — разрешить для Частных сетей.
echo.

%MITM% -s "%SCRIPT%" -p %PORT% --ignore-hosts ".*"

pause
```

> `--ignore-hosts ".*"` — не перехватывать **TLS/HTTPS** (пусть метаданные FOTA идут напрямую). Наш `.zip` всё равно HTTP, он перехватится.

---

## 3) Настрой Windows-хот-спот и брандмауэр

* Включи «Мобильный хот-спот Windows».
  Типичный IP адаптера: `192.168.137.1` (проверить: `ipconfig`).
* Разреши `mitmdump.exe` в **Брандмауэре** (частные/публичные сети).
* Подключи к хот-споту **ГУ**.

---

## 4) Порядок действий при обновлении

1. **Проверка версии (метаданные)**
   Сделай на ГУ **без прокси**, чтобы ABUP вернул актуальный URL и контрольные суммы.

2. **Перед нажатием «Скачать»**
   На ГУ включи **HTTP-прокси**:

   * Хост: `192.168.137.1` (IP ноута)
   * Порт: `8080`

3. **Запусти прокси**
   Через `start_proxy.bat` (или командой):

   ```powershell
   & "C:\Program Files\mitmproxy\bin\mitmdump.exe" -s "C:\fw\serve_zip_range.py" -p 8080 --ignore-hosts ".*"
   ```

4. **Скачай обновление в FOTA**
   В консоли увидишь:

   * один `HEAD 200 size=...`
   * затем множество `[SEND 206] start-end/total` (кусочки \~50 МБ)
   * в конце установка без «verification failed»

> Если в логе вдруг попадётся `[SEND 200] FULL` **посреди** процесса — это ошибка: куски «съедут», MD5 не сойдутся. Проверь, что скрипт не менялся, и что FOTA действительно запрашивает `.zip` с домена `*.mayitek.com`.

---

## 5) После обновления

* Отключи прокси в настройках Wi-Fi ГУ, чтобы интернет вернулся к обычному режиму.
* Можно сохранить `.zip` и скрипт — пригодится для следующих релизов.

---

## Частые проблемы и решения

* **“The verification failed”**

  1. Проверь MD5 локального файла — должен совпадать с тем, что в метаданных FOTA.
  2. Убедись, что все фрагменты отдавались **206 Partial Content**, не было «случайного» `200` посередине.
  3. Делай этап «проверка версии» **без прокси**, а прокси включай только на время скачивания `.zip`.

* **Браузер на телефоне «не открывает сайты» через прокси** — нормально. HTTPS требует установку сертификата mitmproxy, что нам не нужно. FOTA тянет `.zip` по HTTP.

* **Нет запросов в консоли** — либо неверный IP/порт прокси в ГУ, либо брандмауэр Windows блокирует входящие.

* **Домен отличается** (например, `iotdown-xx.mayitek.com`) — скрипт уже ловит любое `*.mayitek.com`. Если нужно жёстче — поменяй фильтр в `HOST_RE`.

---

## Важные предупреждения

* OTA-пакеты часто подписаны и завязаны на конкретную плату/экран/аудио-кодек. Неподходящая сборка может «окирпичить» ГУ.
* Действуй только с **оригинальным архивом** (хэши совпадают с метаданными).
* Делай бэкап, если планируешь экспериментировать.
